/*
 JSONCache version 0.0.1

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(l){var e={version:"0.0.1",debug:!0,prefix:"JSONCache",tryCount:5},i=function(){if(e.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};e.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(c){a=!1}return b&&a}();var j=function(b,a){try{window.localStorage[b]=a}catch(c){i("Error adding data to localStorage, quota might be full.")}},
f={};f.settings=e;f.clear=function(b){if(b)window.localStorage.removeItem(e.prefix+" data "+b),window.localStorage.removeItem(e.prefix+" time "+b);else{var b=RegExp("^"+e.prefix+" (data|time) "),a,c,d=window.localStorage.length,g=[];for(a=0;a<d;++a)c=window.localStorage.key(a),b.test(c)&&g.push(c);d=g.length;for(a=0;a<d;++a)window.localStorage.removeItem(g[a])}};f.purgeOldest=function(){for(var b=RegExp("^"+e.prefix+" time "),a,c=null,d,g,f=window.localStorage.length,h=0;h<f;++h)if(d=window.localStorage.key(h),
b.test(d)&&(g=parseInt(window.localStorage[d],10),!isNaN(g)&&(c===null||g<c)))a=d,c=g;c!==null&&(window.localStorage.removeItem(a.replace(" time "," data ")),window.localStorage.removeItem(a))};f._getJSONProxy=function(b,a){l.ajax(b,a)};f._getTime=function(){return(new Date).getTime().toString()};f._tryGetJSON=function(b,a){var c=a.tryCount||0,d=a.originalError;a.error=function(g,e,h){e==="timeout"?(i("Request timed out,",c,"tries left"),c?(a.tryCount--,f._tryGetJSON(b,a)):typeof d==="function"&&
d(g,e,h)):typeof d==="function"&&d(g,e,h)};c&&f._getJSONProxy(b,a)};f.getCachedJSON=function(b,a){(new Date).getTime();var c=a.success,d=e.prefix+" data "+b,g=e.prefix+" time "+b,k=window.localStorage[d];k?(i("Value found from cache for url:",b),c(JSON.parse(k))):(i("Value not found in cache fetching data from url:",b),a.success=function(a){i("Fetched data, adding to cache for url:",b);j(d,JSON.stringify(a));j(g,f._getTime());c(a)},a.originalError=a.error,a.tryCount=typeof a.tryCount==="number"?a.tryCount:
e.tryCount,a.dataType="json",f._tryGetJSON(b,a))};window.JSONCache=f})(jQuery);
