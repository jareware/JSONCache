/*
 JSONCache version 0.0.1

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(l){var f={version:"0.0.1",debug:!0,prefix:"JSONCache",numTries:5,waitTime:200},g=function(){if(f.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};f.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(d){a=!1}return b&&a}();var j=function(b,a){try{window.localStorage[b]=a}catch(d){g("Error adding data to localStorage, quota might be full.")}},
c={};c.settings=f;c.clear=function(b){if(b)window.localStorage.removeItem(f.prefix+" data "+b),window.localStorage.removeItem(f.prefix+" time "+b);else{var b=RegExp("^"+f.prefix+" (data|time) "),a,d,c=window.localStorage.length,e=[];for(a=0;a<c;++a)d=window.localStorage.key(a),b.test(d)&&e.push(d);c=e.length;for(a=0;a<c;++a)window.localStorage.removeItem(e[a])}};c.purgeOldest=function(){for(var b=RegExp("^"+f.prefix+" time "),a,d=null,c,e,g=window.localStorage.length,i=0;i<g;++i)if(c=window.localStorage.key(i),
b.test(c)&&(e=parseInt(window.localStorage[c],10),!isNaN(e)&&(d===null||e<d)))a=c,d=e;d!==null&&(window.localStorage.removeItem(a.replace(" time "," data ")),window.localStorage.removeItem(a))};c._getJSONProxy=function(b,a){l.ajax(b,a)};c._getTime=function(){return(new Date).getTime().toString()};c._tryGetJSON=function(b,a,d){d>=f.numTries?(g("Tried fetching",d,"times already, returning."),typeof a.JSONCacheError==="function"&&a.JSONCacheError("timeout")):(a.error=function(h,e){g("Ajax error with status:",
e);window.setTimeout(function(){c._tryGetJSON(b,a,d+1)},f.waitTime)},c._getJSONProxy(b,a))};c.getCachedJSON=function(b,a){a=a||{};(new Date).getTime();var d=a.success,h=f.prefix+" data "+b,e=f.prefix+" time "+b,k=window.localStorage[h];k?(g("Value found from cache for url:",b),d(JSON.parse(k))):(g("Value not found in cache fetching data from url:",b),a.success=function(a){g("Fetched data, adding to cache for url:",b);j(h,JSON.stringify(a));j(e,c._getTime());d(a)},a.dataType="json",g("Trying to fetch JSON multiple times."),
c._tryGetJSON(b,a,0))};window.JSONCache=c})(jQuery);
