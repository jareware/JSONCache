/*
 JSONCache version 0.0.2

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(l){var e={version:"0.0.2",debug:!0,prefix:"JSONCache",numTries:5,waitTime:200},h=function(){if(e.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};e.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(d){a=!1}return b&&a}();var k=function(b,a){try{window.localStorage[b]=a}catch(d){h("Error adding data to localStorage, quota might be full.")}},
c={};c.settings=e;c.clear=function(b){if(b)window.localStorage.removeItem(e.prefix+" data "+b),window.localStorage.removeItem(e.prefix+" time "+b);else{var b=RegExp("^"+e.prefix+" (data|time) "),a,d,f=window.localStorage.length,c=[];for(a=0;a<f;++a)d=window.localStorage.key(a),b.test(d)&&c.push(d);f=c.length;for(a=0;a<f;++a)window.localStorage.removeItem(c[a])}};c.purgeOldest=function(){for(var b=RegExp("^"+e.prefix+" time "),a,d=null,c,i,g=window.localStorage.length,j=0;j<g;++j)if(c=window.localStorage.key(j),
b.test(c)&&(i=parseInt(window.localStorage[c],10),!isNaN(i)&&(d===null||i<d)))a=c,d=i;d!==null&&(window.localStorage.removeItem(a.replace(" time "," data ")),window.localStorage.removeItem(a))};c._getJSONProxy=function(b,a){l.ajax(b,a)};c._getTime=function(){return(new Date).getTime().toString()};c._tryGetJSON=function(b,a,d,f){d>e.numTries?(h("Tried fetching",d-1,"times already, returning."),typeof a.JSONCacheError==="function"&&a.JSONCacheError("timeout")):(a.error=function(e,g,j){h("Ajax error with status:",
g);typeof a.errorHook==="function"&&a.errorHook(e,g,j);window.setTimeout(function(){c._tryGetJSON(b,a,d+1,f*2)},f)},typeof a.retryHook==="function"&&a.retryHook(d),c._getJSONProxy(b,a))};c.getCachedJSON=function(b,a){a=a||{};(new Date).getTime();var d=a.success,f=e.prefix+" data "+b,i=e.prefix+" time "+b,g=window.localStorage[f];g?(h("Value found from cache for url:",b),d(JSON.parse(g))):(h("Value not found in cache fetching data from url:",b),a.success=function(a){h("Fetched data, adding to cache for url:",
b);k(f,JSON.stringify(a));k(i,c._getTime());d(a)},a.dataType="json",c._tryGetJSON(b,a,1,e.waitTime))};window.JSONCache=c})(jQuery);
