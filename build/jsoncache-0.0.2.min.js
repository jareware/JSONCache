/*
 JSONCache version 0.0.2

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(l){var e={version:"0.0.2",debug:!0,prefix:"JSONCache",numTries:5,waitTime:200,itemLifetime:3E5},j=function(){if(e.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};e.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(d){a=!1}return b&&a}();var k=function(b,a){try{window.localStorage[b]=
a}catch(d){j("Error adding data to localStorage, quota might be full.")}},c={};c.settings=e;c.clear=function(b){if(b)window.localStorage.removeItem(e.prefix+" data "+b),window.localStorage.removeItem(e.prefix+" time "+b);else{var b=RegExp("^"+e.prefix+" (data|time) "),a,d,f=window.localStorage.length,c=[];for(a=0;a<f;++a)d=window.localStorage.key(a),b.test(d)&&c.push(d);f=c.length;for(a=0;a<f;++a)window.localStorage.removeItem(c[a])}};c.purgeOldest=function(){for(var b=RegExp("^"+e.prefix+" time "),
a,d=null,c,g,h=window.localStorage.length,i=0;i<h;++i)if(c=window.localStorage.key(i),b.test(c)&&(g=parseInt(window.localStorage[c],10),!isNaN(g)&&(d===null||g<d)))a=c,d=g;d!==null&&(window.localStorage.removeItem(a.replace(" time "," data ")),window.localStorage.removeItem(a))};c._getJSONProxy=function(b,a){l.ajax(b,a)};c._getTime=function(){return(new Date).getTime()};c._tryGetJSON=function(b,a,d,f){d>e.numTries?(j("Tried fetching",d-1,"times already, returning."),typeof a.JSONCacheError==="function"&&
a.JSONCacheError("timeout")):(a.error=function(e,h,i){j("Ajax error with status:",h);typeof a.errorHook==="function"&&a.errorHook(e,h,i,d);window.setTimeout(function(){c._tryGetJSON(b,a,d+1,f*2)},f)},typeof a.retryHook==="function"&&a.retryHook(d),c._getJSONProxy(b,a))};var m=function(b){b=parseInt(b,10);return!isNaN(b)&&b+e.itemLifetime>=c._getTime()};c.getCachedJSON=function(b,a){a=a||{};(new Date).getTime();var d=a.success,f=e.prefix+" data "+b,g=e.prefix+" time "+b,h=window.localStorage[f],i=
window.localStorage[g];h&&m(i)?(j("Value found from cache for url:",b),d(JSON.parse(h))):(j("Value not found in cache fetching data from url:",b),a.success=function(a){j("Fetched data, adding to cache for url:",b);k(f,JSON.stringify(a));k(g,c._getTime());d(a)},a.dataType="json",c._tryGetJSON(b,a,1,e.waitTime))};window.JSONCache=c})(jQuery);
