/*
 JSONCache version 0.0.2

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(m){var g={version:"0.0.2",debug:!0,prefix:"JSONCache",numTries:5,waitTime:200,itemLifetime:3E5},i=function(){if(g.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};g.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(c){a=!1}return b&&a}();var k=function(b,a){try{window.localStorage[b]=
a}catch(c){i("Error adding data to localStorage, quota might be full.")}},f={};f.settings=g;var l=function(b){b=parseInt(b,10);return!isNaN(b)&&b+g.itemLifetime>=f._getTime()};f.clear=function(b){if(b)window.localStorage.removeItem(g.prefix+" data "+b),window.localStorage.removeItem(g.prefix+" time "+b);else{var b=RegExp("^"+g.prefix+" (data|time) "),a,c,e=window.localStorage.length,d=[];for(a=0;a<e;++a)c=window.localStorage.key(a),b.test(c)&&d.push(c);e=d.length;for(a=0;a<e;++a)window.localStorage.removeItem(d[a])}};
f.clean=function(){var b=RegExp("^"+g.prefix+" time (.*)$"),a,c,e=[],d,j=window.localStorage.length;for(d=0;d<j;++d)a=window.localStorage.key(d),(c=b.exec(a))&&!l(window.localStorage[a])&&e.push(c[1]);j=e.length;for(d=0;d<j;++d)f.clear(e[d])};f.purgeOldest=function(){for(var b=RegExp("^"+g.prefix+" time "),a,c=null,e,d,f=window.localStorage.length,h=0;h<f;++h)if(e=window.localStorage.key(h),b.test(e)&&(d=parseInt(window.localStorage[e],10),!isNaN(d)&&(c===null||d<c)))a=e,c=d;c!==null&&(window.localStorage.removeItem(a.replace(" time ",
" data ")),window.localStorage.removeItem(a))};f._getJSONProxy=function(b,a){m.ajax(b,a)};f._getTime=function(){return(new Date).getTime()};f._tryGetJSON=function(b,a,c,e){c>g.numTries?(i("Tried fetching",c-1,"times already, returning."),typeof a.JSONCacheError==="function"&&a.JSONCacheError("timeout")):(a.error=function(d,g,h){i("Ajax error with status:",g);typeof a.errorHook==="function"&&a.errorHook(d,g,h,c);window.setTimeout(function(){f._tryGetJSON(b,a,c+1,e*2)},e)},typeof a.retryHook==="function"&&
a.retryHook(c),f._getJSONProxy(b,a))};f.getCachedJSON=function(b,a){a=a||{};(new Date).getTime();var c=a.success,e=g.prefix+" data "+b,d=g.prefix+" time "+b,j=window.localStorage[e],h=window.localStorage[d];j&&l(h)?(i("Value found from cache for url:",b),c(JSON.parse(j))):(i("Value not found in cache fetching data from url:",b),a.success=function(a){i("Fetched data, adding to cache for url:",b);k(e,JSON.stringify(a));k(d,f._getTime());c(a)},a.dataType="json",f._tryGetJSON(b,a,1,g.waitTime))};window.JSONCache=
f})(jQuery);
